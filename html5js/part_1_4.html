<html>
    <head>
        <title>Storing a Celebrity Object</title>
        <meta content="text/html; charset=UTF-8" http-equiv="content-type">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">    
        <link rel="stylesheet" href="../stylesheets/styles.css">
        <link rel="stylesheet" href="../stylesheets/pygment_trac.css">
        <script src="../javascripts/scale.fix.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <!--[if lt IE 9]>
            <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
            <![endif]-->
    </head>
    <body>
        <div class="wrapper">
            <header class="without-description">
                <h1>
                    <a href="../index.html">
                        <img title="Home" style="width: 80px; height: 80px;"
                        alt="HTML5/JS Tutorial"
                        src="../images/icon@2x.png">
                        HTML5/JS Tutorial Part I
                    </a>
                </h1>
                <p></p>
                <p class="view">
                    <a href="https://github.com/FatFractal/hoodyoodoo">View the Project on GitHub <small>FatFractal/hoodyoodoo</small>
                    </a>
                </p>
                <ul>
                    <li><a href="https://github.com/FatFractal/hoodyoodoo/archive/part1.zip">Download <strong>ZIP File</strong></a></li>
                    <li><a href="https://github.com/FatFractal/hoodyoodoo/tree/part1/HTML5/JS">View On <strong>GitHub</strong></a></li>
                </ul>
            </header>
            <section>
                <h2>
                    <a name="html5-js-part-1-4" class="anchor" href="#html5-js-part-1-4"><span class="octicon octicon-link"></span></a>
                    Storing a Celebrity Object
                </h2>
                <h3>Create the UI</h3>
                <p>
                    First, we want to create a UI so the user can create a <em><strong>Celebrity</strong></em> object that is stored to the backend. Add the following to the <code>&lt;body&gt;</code> tag of <code>index.html</code>:
                </p>
<pre><code>&lt;div data-role="page" id="AddCelebrity"&gt;
    &lt;div data-role="header"&gt;
        &lt;a id="doneButton" class="ui-btn-right" onclick="HoodyoodooViewModel.doneAction()"&gt;Done&lt;/a&gt;
        &lt;h1&gt;Add a Celebrity&lt;/h1&gt;
    &lt;/div&gt; &lt;!-- /header --&gt;
    &lt;div data-role="content"&gt;
        &lt;div data-role="fieldcontain"&gt;
            &lt;label for="firstNameField"&gt;First Name&lt;/label&gt;
            &lt;input type="text" id="firstNameField"/&gt;
        &lt;/div&gt;
        &lt;div data-role="fieldcontain"&gt;
            &lt;label for="lastNameField"&gt;Last Name&lt;/label&gt;
            &lt;input type="text" id="lastNameField"/&gt;
        &lt;/div&gt;
        &lt;center id = "fileUploaderContainer"&gt;
            &lt;div id="fileUploaderDropDiv" style="margin:0; padding:0;"&gt;
                &lt;img id= "addCelebImage" class="celebImage" src="Images/addphoto.png"&gt;
            &lt;/div&gt;
        &lt;/center&gt;
    &lt;/div&gt; &lt;!-- /content --&gt;
    &lt;div data-role="footer" data-position="fixed" class="nav-glyphish-example"&gt;
        &lt;div data-role="navbar" class="nav-glyphish-example"&gt;
            &lt;ul&gt;
                &lt;li&gt;&lt;a href="#WouldYa" id="acpwyt" data-icon="custom"&gt;WouldYa&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href="#" id="acpact" data-icon="custom"&gt;Add Celebrity&lt;/a&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt; &lt;!-- /navbar --&gt;
    &lt;/div&gt; &lt;!-- /footer --&gt;
    &lt;div data-role="popup" data-position-to="window" id="addCelebLoginPopup" data-theme="a" class="ui-content"&gt;
        &lt;h1&gt;Please Register/Log In&lt;/h1&gt;
        &lt;div data-role="fieldcontain"&gt;
            &lt;label for="addCelebUsernameField"&gt;Username&lt;/label&gt;
            &lt;input type="text" id="addCelebUsernameField"/&gt;
        &lt;/div&gt;
        &lt;div data-role="fieldcontain"&gt;
            &lt;label for="addCelebPasswordField"&gt;Password&lt;/label&gt;
            &lt;input type="password" id="addCelebPasswordField"/&gt;
        &lt;/div&gt;
        &lt;a id="addCelebrityLoginButton" data-role="button" onclick="HoodyoodooViewModel.login('addCelebrity')"&gt;Log In&lt;/a&gt;
    &lt;/div&gt; &lt;!-- /Login Popup for AddCelebrity --&gt;
    &lt;div data-role="popup" data-position-to="window" id="addGenderPopup" data-theme="a" class="ui-content"&gt;
        &lt;h1&gt;Select Gender&lt;/h1&gt;
        &lt;a id="selectMaleButton" data-role="button" onclick="HoodyoodooViewModel.addGender('male')"&gt;Male&lt;/a&gt;
        &lt;a id="selectFemaleButton" data-role="button" onclick="HoodyoodooViewModel.addGender('female')"&gt;Female&lt;/a&gt;
    &lt;/div&gt; &lt;!-- /Select Gender Popup for AddCelebrity --&gt;
&lt;/div&gt; &lt;!-- /AddCelebrity --&gt;</code></pre>
                <p>
                    There are a few things going on here. First, we create a header containing a title for the page and a "Done" button. Next, in content, we create a form for inputting a celebrity's name, and for uploading a picture. Finally, in the footer, we have a navigation bar with two entries, one for this page and one for the "WouldYa" page, which we will add a little later. We also define the interface for two popups: one for user login and one asking for the gender of the celebrity.
                </p>
                <h3>Add JavaScript</h3>
                <p>
                    The HTML we've just entered depends on a few JavaScript methods. First, let's edit the <code>init</code> function of <strong><em>HoodyoodooViewModel</em></strong>. Here's the new version of the function, with new lines highlighted:
                </p>
<pre><code>init: function() {
    ff.setDebug(G_DEBUG);
    m_doneButton = document.getElementById("doneButton");
    m_firstNameField = document.getElementById("firstNameField");
    m_lastNameField = document.getElementById("lastNameField");
    m_addCelebImage = document.getElementById("addCelebImage");
    m_loadingImageElement = document.getElementById("imgAjaxLoader");
    m_celebrity = new Celebrity();
    loader = new FileUploader();
    loader.init();
}</code></pre>
                <p>
                    This code fills in some of our member variables with references to some divs in our HTML. It also creates a new <strong><em>Celebrity</em></strong> object. Additionally, it creates a <strong><em>FileUploader</em></strong> object and initializes it. <strong><em>FileUploader</em></strong> is a class we use to enable drag-and-drop image uploading for our celebrities. Add the following to your <strong><em>hoodyoodoo.js</em></strong> file:
                </p>
<pre><code>function FileUploader() {
    // constants
    var MAX_FILE_SIZE = 300000;
    var CONTAINER_DIV = "fileUploaderContainer";
    var DROP_DIV = "fileUploaderDropDiv";
    var PREVIEW_IMG = "addCelebImage";
    var self = {
        containerDiv: null,
        containerClass: "",
        files: [],
        fileBytes: null,
        maxFileSize: 300000,
        multiple: false,
        containerWidth: 190, // 204 + 2*padding + border-top
        containerHeight: 241, // 204 + 2*padding + border-top
        init: function() {
            this.containerDiv = document.getElementById(CONTAINER_DIV);
            this.containerDiv.setAttribute("class",  + this.containerClass);

            var dropDiv = document.getElementById(DROP_DIV);
            dropDiv.addEventListener('drop', drop, false);
            dropDiv.addEventListener("dragenter", dragEnter, false);
            dropDiv.addEventListener("dragexit", dragExit, false);
            dropDiv.addEventListener("dragover", dragOver, false);

            var previewImg = document.getElementById(PREVIEW_IMG);
            previewImg.src = "Images/addphoto.png";

            function dragEnter(evt) {
                evt.stopPropagation();
                evt.preventDefault();
            }
            function dragExit(evt) {
                evt.stopPropagation();
                evt.preventDefault();
            }
            function dragOver(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
            }
            function drop(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                self.files = evt.dataTransfer.files;

                file = self.files[0];
                if(file.fileSize > this.maxFileSize) {
                    return;
                }

                // Only process image files.
                var imageType = /image.*/;
                if(!file.type.match(imageType)) {
                    return;
                }

                var reader = new FileReader();
                reader.onerror = function(e) {
                    alert('Error code: ' + e.target.error);
                };

                // Create a closure to capture the file information.
                reader.onload = (function(aFile) {
                    return function(evt) {
                        //dropDiv.setAttribute("class","hasImage");
                        previewImg.src = evt.target.result;
                        HoodyoodooViewModel.addImage();
                    }
                })(file);
                reader.readAsDataURL(file);
            }
        },
        uploaderElement: function() {
            if(this.containerDiv) return this.containerDiv;
            else return false;
        },
        getFiles: function() {
            if(self.files.length > 0) {
                return self.files;
            }
            else return null;
        },
        getByteArray: function(file) {
            if(self.fileBytes > 0) {
                return self.fileBytes;
            }
            else return null;
        }
    }
    return self;
}</code></pre>
                <p>
                    Next, we need to add some members to the view model, <strong><em>HoodyoodooViewModel</em></strong>. The following member is called by <strong><em>FileUploader</em></strong> when it has finished, in order to add the file data to the <strong><em>Celebrity</em></strong> object we're building:
                </p>
<pre><code>addImage:function() {
    var picker = new FileUploader();
    var reader = new FileReader();
    reader.onerror = function(evt) {
        var message;

        switch(evt.target.error.code) {
            case 1:
            message = file.name + " not found.";
            break;
            case 2:
            message = file.name + " has changed on disk, please re-try.";
            break;
            case 3:
            messsage = "Upload cancelled.";
            break;
            case 4:
            message = "Cannot read " + file.name + ".";
            break;
            case 5:
            message = "File too large for browser to upload.";
            break;
        }
    }

    reader.onload = function(evt){
        m_celebrity.imageData = evt.target.result;
    }
    reader.readAsArrayBuffer(file);
}</code></pre>
                <p>
                    Next, we'll add a method for logging in to the API:
                </p>
<pre><code>login: function(callback) {
    if(callback == 'persistWouldYa') {
        // implement later
    } else if(callback == 'addCelebrity') {
        self.showLoading(true);
        var userName = document.getElementById("addCelebUsernameField").value;
        var password = document.getElementById("addCelebPasswordField").value;
        if(userName && password) {
            ff.login(userName, password,
            function(user) {
                self.showLoading(false);
                $("#addCelebLoginPopup").popup('close');
                self.addCelebrity();
            }, function(statusCode, responseText){
                self.showLoading(false);
                console.error("Error "+ statusCode + ": " + JSON.parse(responseText).statusMessage);
            }
            );
        } else {
            alert("You must provide both username and password");
        }
    } else if(callback == 'getTopCelebrity') {
        // implement later
    }
}</code></pre>
                <p>
                    The method simple grabs the username and password entered into the form, then uses the NoServer JavaScript method <code>login</code> to log in to the backend.
                </p>
                <p>
                    Next, there are a couple of utility methods that we need to define. The first, <code>addGender</code>, is used to pop up a query box asking whether a celebrity is male or female, and to store the answer in our <strong><em>Celebrity</em></strong> object. The second, <code>showLoading</code>, shows an animated graphic while things are loading. Here are the methods:
                </p>
<pre><code>addGender: function(gender) {
    $("#addGenderPopup").popup('close');
    if(!gender) {
        $("#addGenderPopup").popup('open');
    } else if(gender == "male") {
        m_celebrity.gender = "male";
        self.addCelebrity();
    } else if(gender == "female") {
        m_celebrity.gender = "female";
        self.addCelebrity();
    }
},
showLoading:function(show) {
    if(m_loadingImageElement == null) {
        var i = document.createElement('img');
        var b = document.getElementById("body");
        i.id = "imgAjaxLoader";
        i.setAttribute("src", "https://ajax.aspnetcdn.com/ajax/jquery.mobile/1.1.0/images/ajax-loader.gif");
        i.setAttribute("class", "imgAjaxLoader");
        b.appendChild(i);
        m_loadingImageElement = document.getElementById("imgAjaxLoader");
    }
    if(show){
        m_loadingImageElement.style.display = 'block';
    } else {
        m_loadingImageElement.style.display = 'none';
    }
}</code></pre>
                <p>
                    Now, we need to define the <code>doneAction</code> method called when the "Done" button is pressed:
                </p>
<pre><code>doneAction: function() {
    if(m_firstNameField.value) m_celebrity.firstName = m_firstNameField.value;
    if(m_lastNameField.value) m_celebrity.lastName = m_lastNameField.value;
    self.addCelebrity();
}</code></pre>
                <p>
                    This method simply copies the values provided in the form to the <strong><em>Celebrity</em></strong> object we created in the <code>init</code> method, then calls a method called <code>addCelebrity</code>. The <code>addCelebrity</code> method is the heart of the page, as this is where our <strong><em>Celebrity</em></strong> object gets stored to our backend:
                </p>
<pre><code>addCelebrity: function() {
    // check logged in
    if(!ff.loggedIn()) {
        $("#addCelebLoginPopup").popup('open');
    } else {
        // check requisite info exists
        if ((m_celebrity.firstName == null) || (m_celebrity.lastName == null)) {
            alert("Add Celebrity Failed. You must provide first and last name for this celebrity");
        }
        else if (m_celebrity.imageData == null) {
            alert("Add Celebrity Failed. You must provide an image for this celebrity");
        }
        else if (m_celebrity.gender == null) {
            self.addGender();
        }
        else {
            console.log("CelebrityViewController createCelebrity: all requisite items exist.");
            console.log("CelebrityViewController createCelebrity newCelebString = " + JSON.stringify(m_celebrity));
            self.showLoading(true);
            ff.createObjAtUri(m_celebrity, "/Celebrity",
            function(data) {
                self.showLoading(false);
                m_firstNameField.value = "";
                m_lastNameField.value = "";
                m_addCelebImage.src = "Images/addphoto.png";
                m_celebrity = null;
            }, function(statusCode, responseText){
                self.showLoading(false);
                console.error("Error "+ statusCode + ": " + JSON.parse(responseText).statusMessage);
            }
            );
        }
    }
}</code></pre>
                <p>
                    After checking that the user is logged in&mdash;a requirement on the FatFractal platform if you want to create any backend objects&mdash;the code does some verification of the data. If all is well, then the FatFractal method <code>createObjAtUri</code> is called, which stores our new <strong><em>Celebrity</em></strong> object in a collection called "/Celebrity".
                </p>
                <p>
                    That’s it! Now, we can select an image from your computer, enter the first and last name, add the gender and the new <em><strong>Celebrity</strong></em> is stored to your API.
                </p>
                <p>
                    As mentioned previously, NoServer APIs can store any type of object, not just JSON or text. In this case, we have stored a <em><strong>Celebrity</strong></em> object that contains an image (<em><strong>byte[]</strong></em>) with a single method and can retrieve it the same way. And that is what we will do next.
                </p>
                <p>
                    Go ahead and add a few celebrities to you API as we will need them for the next section.
                </p>
                <p>
                    Final result - successfully added a Celebrity:
                </p>
                <p class="aligncenter">
                    <a href="http://fatfractal.com/beta/wp-content/uploads/2012/10/A9199CDC-354D-4D5C-976E-994F04447E7B.png"><img src="http://fatfractal.com/beta/wp-content/uploads/2012/10/A9199CDC-354D-4D5C-976E-994F04447E7B.png" alt="" title="Lily Allen" width="597" height="633" class="aligncenter size-full wp-image-8765" /></a>
                </p>
                <p>
                    NEXT: <a href="part_1_5.html">The WouldYa View</a>
                </p>
            </section>
        </div>
        <footer>
            <p>Project maintained by <a href="https://github.com/FatFractal">FatFractal</a></p>
            <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
        </footer>
        <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    </body>
</html>